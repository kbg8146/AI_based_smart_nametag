<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFC 프로비저닝</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 820px; margin: 32px auto; padding: 0 16px; }
    h2 { margin: 0 0 16px; }
    .muted { color:#666; font-size:14px; line-height:1.4; }
    .box { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 12px; }
    label { display:block; font-weight:600; margin: 12px 0 6px; }
    input[type=text] { width:100%; padding:10px 12px; border:1px solid #bbb; border-radius:10px; }
    .row { display:flex; gap:8px; align-items:center; }
    .row > * { flex: 1 1 auto; }
    button { padding:12px 16px; border:0; border-radius:10px; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#444; }
    #log { margin-top:12px; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; color:#333; }
    .ok { color:#0a7b00; } .warn { color:#b15a00; } .err { color:#b00020; }
  </style>
</head>
<body>
  <h2>NFC 프로비저닝</h2>
  <p class="muted">
    · <b>Android의 Chrome + HTTPS</b>에서 Web NFC 쓰기 동작<br />
    · 아래 버튼을 누르고 태그를 휴대폰 뒷면에 대면, UID를 읽어 <code>assign/remap</code>을 수행하고
      받은 URL을 태그에 <b>기록</b>합니다.
  </p>

  <div class="box">
    <label>관리자 키</label>
    <input type="text" id="adminKey" placeholder="예: vmfhaltmskdls" />

    <label>기록할 URL의 베이스(선택) — 비워두면 현재 도메인 사용</label>
    <input type="text" id="baseUrl" placeholder="예: https://nfc.example.com" />

    <label>특정 토큰으로 고정(선택) — 사람 A의 토큰 값</label>
    <input type="text" id="tokenOverride" placeholder="예: 1DOQEGH4 (비우면 자동 assign)" />

    <div class="row">
      <input type="text" id="nameQuery" placeholder="이름으로 토큰 찾기(선택): 예) 김부건" />
      <button class="secondary" id="btnFind">이름으로 찾기</button>
    </div>
    <div class="muted" id="foundInfo"></div>

    <div style="margin-top:14px">
      <button id="btn">스캔 & 기록 (UID → remap/assign → URL 쓰기)</button>
    </div>

    <div id="log"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (m, cls="") => {
      const el = $("log");
      const line = cls ? `<div class="${cls}">${m}</div>` : `<div>${m}</div>`;
      el.innerHTML += line;
      el.scrollTop = el.scrollHeight;
    };
    const norm = (s) => (s || "").toString().normalize("NFKC").replace(/\s+/g,"").toLowerCase();

    // 1) URL 쿼리의 key 자동 채우기
    (function autofillKey(){
      const qs = new URLSearchParams(location.search);
      const k = qs.get("key");
      if (k) $("adminKey").value = k;
    })();

    // 2) 이름으로 토큰 찾기 (/users.json 조회)
    $("btnFind").addEventListener("click", async () => {
      try {
        const q = $("nameQuery").value.trim();
        if (!q) { alert("이름을 입력하세요."); return; }
        $("foundInfo").textContent = "조회 중…";
        const res = await fetch("/users.json", { cache: "no-store" });
        if (!res.ok) throw new Error(await res.text());
        const arr = await res.json();  // 설문 시트 레코드
        // token 필드가 있는 첫 매치
        const target = arr.find(r => norm(r["이름"] || r["Name"] || r["성명"]) === norm(q));
        if (!target) {
          $("foundInfo").textContent = "일치하는 이름을 찾지 못했습니다.";
          return;
        }
        const t = (target["token"] || "").toString().trim();
        if (!t) {
          $("foundInfo").innerHTML = "이 사람의 token이 비어있습니다. 먼저 /admin/generate-tokens를 실행하세요.";
          return;
        }
        $("tokenOverride").value = t;
        $("foundInfo").innerHTML = `찾은 토큰: <b>${t}</b>`;
      } catch (e) {
        $("foundInfo").textContent = "오류: " + (e.message || e);
      }
    });

    // 3) 스캔 → assign/remap → 태그에 URL 쓰기
    $("btn").addEventListener("click", async () => {
      try {
        if (!("NDEFReader" in window)) {
          alert("이 브라우저는 Web NFC를 지원하지 않습니다. Android의 Chrome(HTTPS)에서 사용하세요.");
          return;
        }
        const adminKey = $("adminKey").value.trim();
        if (!adminKey) { alert("관리자 키가 필요합니다."); return; }

        const baseInput = $("baseUrl").value.trim();
        const baseUrl = baseInput || location.origin;
        const tokenOv = $("tokenOverride").value.trim();

        const ndef = new NDEFReader();
        log("NFC 스캔을 시작합니다. 태그를 휴대폰에 대세요…", "muted");
        await ndef.scan();

        ndef.onreadingerror = () => log("태그 읽기 실패. 다시 대보세요.", "warn");
        ndef.onreading = async (event) => {
          try {
            const uid = event.serialNumber || "";
            if (!uid) throw new Error("UID를 읽을 수 없습니다.");

            log(`UID: ${uid}`);

            const endpoint = tokenOv
              ? `/admin/provision/remap?key=${encodeURIComponent(adminKey)}`
              : `/admin/provision/assign?key=${encodeURIComponent(adminKey)}`;
            const payload = tokenOv
              ? { uid, token: tokenOv, base_url: baseUrl }
              : { uid, base_url: baseUrl };

            log(`요청 → ${endpoint}`);
            const res = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              const txt = await res.text();
              throw new Error(`서버 오류(${res.status}): ${txt}`);
            }
            const data = await res.json();    // { uid, token, url, reused?/remapped? }
            log(`응답: ${JSON.stringify(data)}`);

            // 태그에 URL 기록
            const writeUrl = data.url;
            const writer = new NDEFReader();
            await writer.write({ records: [ { recordType: "url", data: writeUrl } ] });
            log(`태그에 기록 완료 → ${writeUrl}`, "ok");
            alert(`완료!\nUID=${uid}\n토큰=${data.token}\nURL=${writeUrl}`);
          } catch (e) {
            log("오류: " + (e.message || e), "err");
            alert(e.message || e);
          }
        };
      } catch (e) {
        log("오류: " + (e.message || e), "err");
        alert(e.message || e);
      }
    });
  </script>
</body>
</html>

